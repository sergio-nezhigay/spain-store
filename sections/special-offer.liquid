{% liquid
  assign fetch_priority = 'auto'
  if section.index == 1
    assign fetch_priority = 'high'
  endif

  assign has_media = false
  if section.settings.image != blank or section.settings.video != blank
    assign has_media = true
  endif

  assign media_width_desktop = '100vw'
  assign media_width_mobile = '100vw'
  assign sizes = '(min-width: 750px) ' | append: media_width_desktop | append: ', ' | append: media_width_mobile
  assign widths = '832, 1200, 1600, 1920, 2560, 3840'
%}

<div
  id="SpecialOffer-{{ section.id }}"
  class="special-offer color-{{ section.settings.color_scheme }}"
  style="
    --special-offer-border-style: {{ section.settings.border }};
    --special-offer-border-width: {{ section.settings.border_width }}px;
    --special-offer-border-opacity: {{ section.settings.border_opacity }}%;
    {% if section.settings.section_height == 'custom' %}
      --special-offer-min-height: {{ section.settings.section_height_custom }}svh;
    {% elsif section.settings.section_height == 'full-screen' %}
      --special-offer-min-height: 100svh;
    {% else %}
      --special-offer-min-height: var(--section-height-{{ section.settings.section_height }});
    {% endif %}
  "
>
  <div
    class="special-offer__container spacing-style section section--full-width"
    style="{% render 'spacing-style', settings: section.settings %}"
  >
    <div class="special-offer__media-wrapper">
      {% liquid
        if section.settings.toggle_overlay
          render 'overlay', settings: section.settings
        endif
      %}

      {% if section.settings.media_type == 'video' and section.settings.video != blank %}
        <div class="special-offer__video-wrapper">
          {% if section.settings.video.preview_image %}
            {{
              section.settings.video.preview_image
              | image_url: width: 3840
              | image_tag:
                width: section.settings.video.preview_image.width,
                widths: widths,
                height: section.settings.video.preview_image.height,
                alt: section.settings.video.alt,
                class: 'special-offer__video-poster',
                sizes: sizes,
                fetchpriority: fetch_priority
            }}
          {% endif %}
          {{
            section.settings.video
            | video_tag:
              poster: nil,
              autoplay: true,
              loop: true,
              controls: false,
              muted: true,
              class: 'special-offer__video'
          }}
        </div>
      {% elsif section.settings.image != blank %}
        {{
          section.settings.image
          | image_url: width: 3840
          | image_tag:
            width: section.settings.image.width,
            widths: widths,
            height: section.settings.image.height,
            alt: section.settings.image.alt,
            class: 'special-offer__image',
            sizes: sizes,
            fetchpriority: fetch_priority
        }}
      {% else %}
        {{ 'hero-apparel-1' | placeholder_svg_tag: 'special-offer__image' }}
      {% endif %}
    </div>

    <div class="special-offer__content-wrapper section-content-wrapper {{ section.settings.section_width }}">
      <special-offer-component
        class="special-offer__content"
        data-promo-code="{{ section.settings.promo_code }}"
      >
        <div class="special-offer__form-container" ref="formContainer">
          {% if section.settings.heading != blank %}
            <h2 class="special-offer__heading {{ section.settings.heading_preset }}">
              {{ section.settings.heading }}
            </h2>
          {% endif %}

          {% if section.settings.description != blank %}
            <div class="special-offer__description {{ section.settings.description_preset }}">
              {{ section.settings.description }}
            </div>
          {% endif %}

          {% form 'customer', class: 'special-offer__form' %}
            <div class="special-offer__input-group">
              <label for="SpecialOfferEmail-{{ section.id }}" class="visually-hidden">
                Email address
              </label>
              <input
                id="SpecialOfferEmail-{{ section.id }}"
                class="special-offer__input"
                type="email"
                name="contact[email]"
                ref="emailInput"
                autocorrect="off"
                autocapitalize="off"
                autocomplete="email"
                placeholder="{{ section.settings.input_placeholder }}"
                required
              >
              <button
                type="submit"
                class="special-offer__button {{ section.settings.button_style }}"
                ref="submitButton"
              >
                {{ section.settings.button_label }}
              </button>
            </div>

            <div class="special-offer__error" ref="errorMessage" style="display: none;">
              <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" focusable="false" aria-hidden="true" class="icon-error">
                {% render 'icon', icon: 'error' %}
              </svg>
              <span ref="errorText"></span>
            </div>
          {% endform %}
        </div>

        <div class="special-offer__success-container" ref="successContainer" style="display: none;">
          {% if section.settings.success_heading != blank %}
            <h2 class="special-offer__success-heading {{ section.settings.heading_preset }}">
              {{ section.settings.success_heading }}
            </h2>
          {% endif %}

          {% if section.settings.success_message != blank %}
            <p class="special-offer__success-message">
              {{ section.settings.success_message }}
            </p>
          {% endif %}

          <div class="special-offer__promo-code-container">
            <div class="special-offer__promo-code" ref="promoCodeDisplay">
              {{ section.settings.promo_code }}
            </div>
            <button
              type="button"
              class="special-offer__copy-button {{ section.settings.button_style }}"
              on:click="copyPromoCode"
              ref="copyButton"
            >
              <span ref="copyButtonText">{{ section.settings.copy_button_label }}</span>
            </button>
          </div>
        </div>
      </special-offer-component>
    </div>
  </div>
</div>

<script src="{{ 'special-offer.js' | asset_url }}" defer></script>

{% stylesheet %}
  .special-offer {
    position: relative;
    min-height: var(--special-offer-min-height);
  }

  .special-offer__container {
    position: relative;
    overflow: hidden;
    border: var(--special-offer-border-width) var(--special-offer-border-style) rgb(var(--color-border-rgb) / var(--special-offer-border-opacity));
    min-height: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .special-offer__media-wrapper {
    position: absolute;
    inset: 0;
    z-index: var(--layer-base);
  }

  .special-offer__image,
  .special-offer__video,
  .special-offer__video-poster {
    height: 100%;
    width: 100%;
    object-fit: cover;
    object-position: center center;
    overflow: hidden;
    position: relative;
    z-index: var(--layer-base);
  }

  .special-offer__video-wrapper {
    position: relative;
    height: 100%;
    width: 100%;
  }

  .special-offer__video-poster {
    position: absolute;
  }

  .special-offer__content-wrapper {
    position: relative;
    z-index: var(--layer-flat);
    width: 100%;
    padding: var(--page-margin);
  }

  .special-offer__content-wrapper.page-width {
    max-width: var(--page-width);
  }

  .special-offer__content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--gap-lg);
  }

  .special-offer__heading {
    margin: 0;
    color: var(--color-foreground-heading);
  }

  .special-offer__description {
    color: var(--color-foreground);
    max-width: 600px;
  }

  .special-offer__form {
    width: 100%;
    max-width: 500px;
  }

  .special-offer__input-group {
    display: flex;
    gap: var(--gap-xs);
    flex-direction: column;

    @media screen and (min-width: 750px) {
      flex-direction: row;
    }
  }

  .special-offer__input {
    flex: 1;
    padding: var(--padding-lg) var(--padding-xl);
    border: 1px solid var(--color-input-border);
    border-radius: var(--button-border-radius);
    background-color: var(--color-input-background);
    color: var(--color-input-text);
    font-size: 1rem;
    width: 100%;

    @media screen and (min-width: 750px) {
      width: auto;
    }
  }

  .special-offer__input::placeholder {
    color: rgb(var(--color-input-text-rgb) / var(--opacity-70));
  }

  .special-offer__input:focus {
    outline: 2px solid var(--color-input-text);
    outline-offset: 2px;
  }

  .special-offer__button {
    padding: var(--padding-lg) var(--padding-3xl);
    white-space: nowrap;
    border-radius: var(--button-border-radius);
    cursor: pointer;
    transition: all var(--animation-values);
    width: 100%;

    @media screen and (min-width: 750px) {
      width: auto;
    }
  }

  .special-offer__button.button {
    background-color: var(--button-background-color);
    color: var(--button-color);
    border: none;
    text-transform: var(--button-text-case-primary);
  }

  .special-offer__button.button-secondary {
    background-color: var(--button-background-color-secondary);
    color: var(--button-color-secondary);
    border: 1px solid var(--color-border);
    text-transform: var(--button-text-case-secondary);
  }

  .special-offer__error {
    display: flex;
    align-items: center;
    gap: var(--gap-xs);
    color: var(--color-error, #c00);
    margin-block-start: var(--margin-sm);
  }

  .special-offer__error .icon-error {
    width: 20px;
    height: 20px;
    fill: currentColor;
  }

  .special-offer__success-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--gap-lg);
  }

  .special-offer__success-heading {
    margin: 0;
    color: var(--color-foreground-heading);
  }

  .special-offer__success-message {
    color: var(--color-foreground);
    max-width: 500px;
    margin: 0;
  }

  .special-offer__promo-code-container {
    display: flex;
    flex-direction: column;
    gap: var(--gap-sm);
    align-items: center;
    width: 100%;
    max-width: 400px;

    @media screen and (min-width: 750px) {
      flex-direction: row;
    }
  }

  .special-offer__promo-code {
    flex: 1;
    padding: var(--padding-lg) var(--padding-xl);
    background-color: rgb(var(--color-background-rgb) / 0.9);
    border: 2px dashed var(--color-border);
    border-radius: var(--button-border-radius);
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    color: var(--color-foreground);
    text-align: center;
    width: 100%;

    @media screen and (min-width: 750px) {
      width: auto;
    }
  }

  .special-offer__copy-button {
    padding: var(--padding-lg) var(--padding-xl);
    border-radius: var(--button-border-radius);
    cursor: pointer;
    transition: all var(--animation-values);
    width: 100%;

    @media screen and (min-width: 750px) {
      width: auto;
    }
  }

  .special-offer__copy-button.button {
    background-color: var(--button-background-color);
    color: var(--button-color);
    border: none;
  }

  .special-offer__copy-button.button-secondary {
    background-color: var(--button-background-color-secondary);
    color: var(--button-color-secondary);
    border: 1px solid var(--color-border);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Special Offer",
  "tag": "section",
  "class": "special-offer-wrapper section-wrapper",
  "disabled_on": {
    "groups": ["header"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Offer Details"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Get 10% Off Your First Order!"
    },
    {
      "type": "select",
      "id": "heading_preset",
      "label": "Heading style",
      "options": [
        {
          "value": "h1",
          "label": "H1"
        },
        {
          "value": "h2",
          "label": "H2"
        },
        {
          "value": "h3",
          "label": "H3"
        }
      ],
      "default": "h1"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>Subscribe to our newsletter and receive an exclusive promo code!</p>"
    },
    {
      "type": "select",
      "id": "description_preset",
      "label": "Description style",
      "options": [
        {
          "value": "paragraph",
          "label": "Paragraph"
        },
        {
          "value": "h5",
          "label": "H5"
        },
        {
          "value": "h6",
          "label": "H6"
        }
      ],
      "default": "paragraph"
    },
    {
      "type": "text",
      "id": "promo_code",
      "label": "Promo Code",
      "default": "WELCOME10",
      "info": "This code will be displayed to customers after they submit their email"
    },
    {
      "type": "header",
      "content": "Form Settings"
    },
    {
      "type": "text",
      "id": "input_placeholder",
      "label": "Email input placeholder",
      "default": "Enter your email"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Submit button label",
      "default": "Get My Code"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button style",
      "options": [
        {
          "value": "button",
          "label": "Primary"
        },
        {
          "value": "button-secondary",
          "label": "Secondary"
        }
      ],
      "default": "button"
    },
    {
      "type": "header",
      "content": "Success State"
    },
    {
      "type": "text",
      "id": "success_heading",
      "label": "Success heading",
      "default": "Thank You!"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success message",
      "default": "Here's your exclusive promo code:"
    },
    {
      "type": "text",
      "id": "copy_button_label",
      "label": "Copy button label",
      "default": "Copy Code"
    },
    {
      "type": "header",
      "content": "Media"
    },
    {
      "type": "select",
      "id": "media_type",
      "label": "Media type",
      "options": [
        {
          "value": "image",
          "label": "Image"
        },
        {
          "value": "video",
          "label": "Video"
        }
      ],
      "default": "image"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Background image"
    },
    {
      "type": "video",
      "id": "video",
      "label": "Background video"
    },
    {
      "type": "checkbox",
      "id": "toggle_overlay",
      "label": "Add overlay",
      "default": true
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Overlay color",
      "alpha": true,
      "default": "#00000066"
    },
    {
      "type": "select",
      "id": "overlay_style",
      "label": "Overlay style",
      "options": [
        {
          "value": "solid",
          "label": "Solid"
        },
        {
          "value": "gradient",
          "label": "Gradient"
        }
      ],
      "default": "solid"
    },
    {
      "type": "select",
      "id": "gradient_direction",
      "label": "Gradient direction",
      "options": [
        {
          "value": "to top",
          "label": "Up"
        },
        {
          "value": "to bottom",
          "label": "Down"
        }
      ],
      "default": "to top"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Content width",
      "options": [
        {
          "value": "page-width",
          "label": "Page width"
        },
        {
          "value": "full-width",
          "label": "Full width"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "select",
      "id": "section_height",
      "label": "Section height",
      "options": [
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        },
        {
          "value": "full-screen",
          "label": "Full screen"
        },
        {
          "value": "custom",
          "label": "Custom"
        }
      ],
      "default": "medium"
    },
    {
      "type": "range",
      "id": "section_height_custom",
      "label": "Custom height",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 50,
      "unit": "%"
    },
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "border",
      "label": "Border",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "solid",
          "label": "Solid"
        }
      ],
      "default": "none"
    },
    {
      "type": "range",
      "id": "border_width",
      "label": "Border width",
      "min": 0,
      "max": 10,
      "step": 1,
      "unit": "px",
      "default": 1
    },
    {
      "type": "range",
      "id": "border_opacity",
      "label": "Border opacity",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 60
    }
  ],
  "presets": [
    {
      "name": "Special Offer",
      "category": "Promotional"
    }
  ]
}
{% endschema %}
